# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

services:


  redis:
    image: docker.io/bitnami/redis:latest
    volumes:
      - 'redis_data:/bitnami'
    environment:
      # ALLOW_EMPTY_PASSWORD is recommended only for development.
      - ALLOW_EMPTY_PASSWORD=yes
  airflow-scheduler:
    image: docker.io/bitnami/airflow:2
    environment:
      - AIRFLOW_COMPONENT_TYPE=scheduler
      - AIRFLOW_DATABASE_NAME=airflow
      - AIRFLOW_DATABASE_USERNAME=airflow_user
      - AIRFLOW_DATABASE_PASSWORD=user4airflow
      - AIRFLOW_EXECUTOR=CeleryExecutor
      - AIRFLOW_WEBSERVER_HOST=airflow
#        old env
      - AIRFLOW_FERNET_KEY=Z2uDm0ZL60fXNkEXG8LW99Ki2zf8wkmIltaTz1iQPDU=
      - AIRFLOW_DATABASE_HOST=postgres
#      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5436/airflow

      - AIRFLOW_LOAD_EXAMPLES=yes
      - AIRFLOW_CONN_EXAMPLE_DB=postgres://example:example@postgres:5436/example
      - AIRFLOW_WEBSERVER_HOST=airflow
      - AIRFLOW_WEBSERVER_PORT_NUMBER=8070
      - OPENLINEAGE_CONFIG=/opt/bitnami/airflow/openlineage.yml
    env_file:
      - openlineage.env

    volumes:
      - ../../../runtime-volumes/airflow-volumes/dags:/opt/bitnami/airflow/dags
      - ../../../exchange/distribution-hub:/mnt/distribution-hub
      - ${PWD}/whl:/whl
      - type: bind
        source: ${PWD}/requirements.txt
        target: /bitnami/python/requirements.txt
      - type: bind
        source: ${PWD}/openlineage.yml
        target: /opt/bitnami/airflow/openlineage.yml


  airflow-worker:
    image: docker.io/bitnami/airflow:2
    environment:
      - AIRFLOW_COMPONENT_TYPE=worker
      - AIRFLOW_DATABASE_NAME=bitnami_airflow
      - AIRFLOW_DATABASE_USERNAME=bn_airflow
      - AIRFLOW_DATABASE_PASSWORD=bitnami1
      - AIRFLOW_EXECUTOR=CeleryExecutor
      - AIRFLOW_WEBSERVER_HOST=airflow
    volumes:
      - ../../../runtime-volumes/airflow-volumes/dags:/opt/bitnami/airflow/dags
      - ../../../exchange/distribution-hub:/mnt/distribution-hub
      - ${PWD}/whl:/whl
      - type: bind
        source: ${PWD}/requirements.txt
        target: /bitnami/python/requirements.txt
      - type: bind
        source: ${PWD}/openlineage.yml
        target: /opt/bitnami/airflow/openlineage.yml


  airflow:
    image: docker.io/bitnami/airflow:2
    ports:
      - '8070:8070'
    environment:
      - AIRFLOW_DATABASE_NAME=bitnami_airflow
      - AIRFLOW_DATABASE_USERNAME=bn_airflow
      - AIRFLOW_DATABASE_PASSWORD=bitnami1
      - AIRFLOW_EXECUTOR=CeleryExecutor
#   old
      - AIRFLOW_FERNET_KEY=Z2uDm0ZL60fXNkEXG8LW99Ki2zf8wkmIltaTz1iQPDU=
      - AIRFLOW_DATABASE_HOST=postgres
        #      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5436/airflow
      - AIRFLOW_LOAD_EXAMPLES=yes
      - AIRFLOW_CONN_EXAMPLE_DB=postgres://example:example@postgres:5436/example
      - AIRFLOW_WEBSERVER_HOST=airflow
      - AIRFLOW_WEBSERVER_PORT_NUMBER=8070
      - AIRFLOW__OPENLINEAGE__CONFIG_PATH='/opt/bitnami/airflow/openlineage.yml'
    env_file:
      - openlineage.env
    volumes:
      - ../../../runtime-volumes/airflow-volumes/dags:/opt/bitnami/airflow/dags
      - ../../../exchange/distribution-hub:/mnt/distribution-hub
      - ${PWD}/whl:/whl
      - type: bind
        source: ${PWD}/requirements.txt
        target: /bitnami/python/requirements.txt
      - type: bind
        source: ${PWD}/openlineage.yml
        target: /opt/bitnami/airflow/openlineage.yml

volumes:
  postgresql_data:
    driver: local
  redis_data:
    driver: local
